name: Deploy to Vercel

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Pull Vercel environment
        run: npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build with Vercel
        run: npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (Production)
        run: npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
name: Vercel Deploys (Preview + Production)

on:
  push:
    branches:
      - '**'         # run on all branches; jobs guard main vs non-main
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: vercel-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preview:
    name: Deploy Preview (non-main branches)
    if: ${{ github.ref != 'refs/heads/main' && secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Vercel Preview Deploy
        uses: vercel/action@v3
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prebuilt"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

  preview-skip:
    name: Skip Preview (missing secrets)
    if: ${{ github.ref != 'refs/heads/main' && (secrets.VERCEL_TOKEN == '' || secrets.VERCEL_ORG_ID == '' || secrets.VERCEL_PROJECT_ID == '') }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Preview deploy skipped: set VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID to enable auto preview deploys."

  production:
    name: Production Deploy (main): Action if secrets, else Hook
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy with Vercel Action (preferred)
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
        uses: vercel/action@v3
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod --prebuilt"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: Resolve deploy hook URL (fallback)
        if: ${{ !(secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '') }}
        shell: bash
        env:
          SECRET: ${{ secrets.VERCEL_DEPLOY_HOOK_URL || '' }}
          VAR: ${{ vars.VERCEL_DEPLOY_HOOK_URL || '' }}
        run: |
          set -euo pipefail
          HOOK_URL="${SECRET:-}"
          if [ -z "$HOOK_URL" ]; then HOOK_URL="${VAR:-}"; SOURCE="vars"; else SOURCE="secrets"; fi
          if [ -n "$HOOK_URL" ]; then
            echo "HOOK_URL=$HOOK_URL" >> "$GITHUB_ENV"
            echo "::add-mask::$HOOK_URL"
            echo "âœ… Resolved HOOK_URL from $SOURCE"
          else
            echo "HOOK_URL=" >> "$GITHUB_ENV"
          fi

      - name: Trigger Vercel deploy hook (fallback)
        if: ${{ !(secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '') }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${HOOK_URL:-}" ]; then
            echo "::error::Missing VERCEL_DEPLOY_HOOK_URL. Add as a Repository Secret (preferred) or Variable."
            exit 1
          fi
          echo "ðŸš€ Triggering Vercel deploy hook..."
          response=$(curl -fsS --retry 3 --retry-delay 2 -X POST "$HOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{}' || true)
          if [ -z "$response" ]; then
            echo "::warning::No response body (hook accepted silently or rate-limited)."
          else
            echo "âœ… Hook response:"
            echo "$response"
          fi
          echo "ðŸŽ¯ Production deployment trigger completed (fallback)."
